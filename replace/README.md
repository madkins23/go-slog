# Support for `HandlerOptions.ReplaceAttr`

The `replace` package provides a number of functions that can provide appropriate functions for use with
[`HandlerOptions.ReplaceAttr`](https://pkg.go.dev/golang.org/x/exp/slog#HandlerOptions).

An early intention was to "fix" non-conformant handlers by providing
`ReplaceAttr` functions that could make them conformant.
Sadly this has not thus far turned out to be the case (2024-03-18).

## Function Types

The `ReplaceAttr` option takes a function that will be applied to each attribute that is to be logged.
The attribute may be returned as is or altered by the function.
The function is defined in the `HandlerOptions.ReplaceAttr` field declaration,
but a convenience definition is found in `go-slog/infra.AttrFn`:

```go
type AttrFn func(groups []string, a slog.Attr) slog.Attr
```

This document describes two function signatures.

The original functions (e.g. `replace.RemoveEmptyKey`)
implement the type described above as `infra.AttrFn`,
which is described in the `HandlerOptions.ReplaceAttr` field declaration.
These functions are now deprecated in favor of the newer functions.
This may turn out to be a mistake but there's no V2 on the horizon
so they can just be de-deprecated at a later time.
_However_, be aware that they are no longer tested or supported and are
likely to be really inefficient compared to the newer functions.

The newer `replace` functions do not conform to this function signature,
rather they _return_ functions that conform to `infra.AttrFn`.
Thus setting the value of the `ReplaceAttr` field requires the execution
of one of the functions, not the function itself.

## Older Functions

As mentioned before, these functions are currently marked as deprecated.
The also conform to `infra.AttrFn` and so the function pointer is set
as the value of `ReplaceAttr`, not the value returned by executing the function.

Rather than go into detail here, the relevant functions will be added
to the following sections.

## Newer Functions

Some of the newer functions share similar arguments:

* `caseInsensitive bool`  
  Most (if not all) `replace` functions will match against a field name.
  This match is much faster if it is exact (case-_sensitive_) so that is the default (`false`).
  Setting the `caseInsensitive` flag causes all matches to be done after converting
  both strings into the same case.
* `grpChk GroupCheck`  
  A function that determines if the current stack of `group` names is acceptable.
  For example, `replace.TopCheck` returns `true` only if the stack is empty,
  indicating the attribute is not inside of a `group`.

```go
type GroupCheck func(groups []string) bool
```

### `ChangeCase`

```go
ChangeCase(
	key string, chgCase ChangeCases, caseInsensitive bool, grpChk GroupCheck
	) infra.AttrFn
```

Changes the case of the string value of any attribute matching the specified key to
upper-, or lower-case as required. For example:
```go
options := &slog.HandlerOptions{
	ReplaceAttr: replace.ChangeCase(
		"level", replace.CaseLower, false, replace.TopCheck)
}
```
returns an `infra.AttrFn` that will match on attributes with
the key `"level"` matched precisely (_not_ case-insensitive)
at the top level of the log record (not within a group)
and change the string value of that attribute to lower case.

The second argument is of type `replace.ChangeCases` with values
`replace.CaseNone`, `replace.CaseLower`, and `replace.CaseUpper`.
The default value is `replace.CaseNone` which means no change.

The following older functions are deprecated by `ChangeCase`:

* `LevelLowerCase`  
  `replace.ChangeCase("level", CaseLower, false, TopCheck)`
* `LevelUpperCase`  
  `replace.ChangeCase("level", CaseUpper, false, TopCheck)`

### `ChangeKey`

```go
ChangeKey(
	from, to string, caseInsensitive bool, grpChk GroupCheck
	) infra.AttrFn
```

Changes the key of the attribute with the specified new value.
```go
options := &slog.HandlerOptions{
	ReplaceAttr: replace.ChangeKey(
		"message", slog.MessageKey, false, replace.TopCheck)
}
```
returns an `infra.AttrFn` that will match on attributes with the key `"message"` and
change it to the value of `slog.MessageKey` (which is `"msg"`).

The following older functions are deprecated by `ChangeKey`:

* `MessageToMsg`  
  `replace.ChangeKey("message", slog.MessageKey, false, TopCheck)`
* `LvlToLevel`  
  `replace.ChangeKey("lvl", slog.LevelKey, false, TopCheck)`

### `ChangeValue`

```go
ChangeValue(
	key string, chgFn ChangeFn, caseInsensitive bool, grpChk GroupCheck
	) infra.AttrFn
```

Changes the value of the string value of any attribute matching the specified key.
The new value is generated by executing a `replace.ChangeFn`:
```go
type ChangeFn func(value slog.Value) slog.Value
```
provided by the caller.

The function `ChangeCase` calls `ChangeValue`:
```go
// Return a function that changes the case of any string per chgCase.
return ChangeValue(key, func(val slog.Value) slog.Value {
    return slog.StringValue(fn(val.String()))
}, caseInsensitive, grpChk)
```

### `RemoveKey`

```go
RemoveKey(key string, caseInsensitive bool, grpChk GroupCheck) infra.AttrFn
```

Removes a specified attribute by changing it to
the empty attribute (`slog.Attr{}`) which is supposed to be ignored.[^1]
```go
options := &slog.HandlerOptions{
	ReplaceAttr: replace.RemoveKey(slog.TimeKey, false, TopCheck)
}
```
removes the `slog.TimeKey` (`time`) key so that the time will not be shown.[^2]

The following older functions are deprecated by `RemoveKey`:

* `RemoveTime`  
  `replace.RemoveKey(slog.TimeKey, false, TopCheck)`
* `RemoveEmptyKey`  
  `replace.RemoveKey("", false, nil)`

## `GroupCheck` Functions

* `TopCheck`  
  Use the function pointer, returns `true` if the `group` stack is empty.
* `Current`
  Use the result of executing this function with a specified `group` name.
  The resulting function will return `true` if that name is at the top
  of the `groups` stack (highest indexed item in the array).
  An empty stack always returns `false`.

[^1]: This is why the `EmptyAttributes` warning is important.

[^2]: This is why the `NoReplAttrBasic` warning is important.
Also `NoReplAttr`, obviously, or none of this will work. ;-)